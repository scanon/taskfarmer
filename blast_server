#!/usr/bin/perl

use Socket;

$server_port=4999;
$MAX=100;
$|=1;

# make the socket
socket(SERVER, PF_INET, SOCK_STREAM, getprotobyname('tcp'));

# so we can restart our server quickly
setsockopt(SERVER, SOL_SOCKET, SO_REUSEADDR, 1);

# build up my socket address
$my_addr = sockaddr_in($server_port, INADDR_ANY);
bind(SERVER, $my_addr)
    or die "Couldn't bind to port $server_port : $!\n";

# establish a queue for incoming connections
listen(SERVER, SOMAXCONN)
    or die "Couldn't listen on port $server_port : $!\n";

# accept and process connections
$item=0;
$remaining=1;
$shutdown=0;
open(PROGRESS,">> ./progress");
open(OUTPUT,">> ./final.output");
open(ERROR,">> ./error.output");
$SIG{INT} = \&catch_int;  # best strategy
while ($remaining){
  $address=accept(CLIENT, SERVER);
  next unless $address;
  ($cDomain, $cPort, $cAdd) = unpack('S n a4 x8', $address);
  $cHost=join('.',unpack('C4', $cAdd));

  $got_response=0;
  $send_query=0;
  $ident="noid";
# Read from client
#
  while(<CLIENT>){
    if (/^RESULTS /){
      $lines=0;
      ($COMMAND,$seq)=split;
      chomp $seq;
      while(! $got_response){
        $_=<CLIENT>;
        if (/^DONE$/){
          if (defined $start{$seq}){
            printf PROGRESS "%s:%s:%d:%d:%d\n", 
		$seq,$ident,time-$start{$seq},
		$lines,time;
            printf "%-8d seq:%25s host:%-16s  time:%-4ds lines: %d\n", 
		$processed, $seq,$ident,
		time-$start{$seq},$lines;
            delete $start{$seq};
            $processed++;
          }
          else{
            print stderr "Unexpect report from $cHost:$ident for $seq\n";
          }
          print CLIENT "RECEIVED $seq\n";
          $got_response=1;
        }
        else{ 
          print OUTPUT;
          $lines++;
        }
        $got_response=1 unless $_;  # catch the edge case
      } # While for response
    }   #
    elsif (/^IDENT /){
      ($COMMAND,$ident)=split;
    }
    elsif (/^NEXT$/){
      $send_query=1;
    }
    else{
      print stderr "Recieved unusual response from $cHost: $_";
    }
  }
#
# Were we expecting a response but didn't get one?
#
#  if ($sent{$seq}>0 && ! $got_response){
#    print ERROR "no report for $seq{$cHost}:$headers{$cHost} from $cHost\n" if defined $sent{$cHost};
#    print "no report for $sent{$cHost}:$headers{$cHost} from $cHost\n" if defined $sent{$cHost};
#  }
#
# Do we need to send a query?  Make sure we aren't in a shutdown.
#
  if ($send_query && ! $shutdown){
    $next=1;
    $header=0;
    while($next eq 1){
      last if eof(stdin);
      $_=<>;
      ($bl,$header,$rest)=split /[> ]/ unless $header;
      print CLIENT $_;
      $next=0 if /^$/;
    }
    $start{$header}=time if $header ne 0;
    print "Sent: $item:$header to $cHost:$ident\n";
    $item++;
  }
  close CLIENT;
  if ( eof(stdin) || $shutdown){
    $shutdown=1;
    $remaining=keys %start;
    print "Draining: $remaining remaining connections\n";
  }
}

close PRROGRESS;
close OUTPUT;
close ERROR;
close SERVER ;

sub catch_int {
  my $signame = shift;
  if ($shutdown){
    close PRROGRESS;
    close OUTPUT;
    close ERROR;
    close SERVER ;
    close PROGRESS;
    print "Exiting\n";
    exit;
  }
  else{
    $shutdown=1;
    $remaining=keys %sent;
    print "Shutting down\n";
    print "Draining: $remaining remaining connections\n";
  }
}

